<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Queue Player</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #ffffff; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; min-height: 100vh; box-sizing: border-box; }
        .container { width: 100%; max-width: 800px; background-color: #1e1e1e; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
        h1, h2 { text-align: center; color: #1DB954; }
        #login-screen, #player-screen { width: 100%; }
        #login-screen { text-align: center; padding: 50px 0; }
        .spotify-btn { background-color: #1DB954; color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; text-decoration: none; transition: background-color 0.2s; }
        .spotify-btn:hover { background-color: #1ED760; }
        #player-info { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; background-color: #282828; padding: 10px; border-radius: 8px; }
        #album-art { width: 80px; height: 80px; border-radius: 4px; object-fit: cover; }
        #track-info { display: flex; flex-direction: column; }
        #track-name { font-size: 1.2em; font-weight: bold; }
        #artist-name { color: #b3b3b3; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        #song-input { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #555; background-color: #333; color: #fff; font-size: 16px; }
        #add-btn { padding: 10px 20px; border: none; border-radius: 5px; background-color: #1DB954; color: #ffffff; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #queue-list { list-style: none; padding: 0; }
        #queue-list li { background-color: #282828; padding: 10px 15px; border-radius: 5px; margin-bottom: 8px; }
        footer { margin-top: 30px; color: #555; text-align: center; font-size: 0.9em; }
        footer a { color: #888; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spotify Queue Player</h1>
        
        <div id="login-screen">
            <p>Login dengan akun Spotify Premium untuk memulai.</p>
            <button id="login-btn" class="spotify-btn">Login dengan Spotify</button>
        </div>

        <div id="player-screen" style="display:none;">
            <div id="player-info">
                <img id="album-art" src="https://i.scdn.co/image/ab67616d0000b2733b5e11ca1b063583df9492db" alt="Album Art">
                <div id="track-info">
                    <div id="track-name">Tidak ada lagu yang diputar</div>
                    <div id="artist-name">...</div>
                </div>
            </div>

            <div class="controls">
                <input type="text" id="song-input" placeholder="Cari judul lagu dan artis...">
                <button id="add-btn">Tambah ke Antrian</button>
            </div>

            <div class="queue-container">
                <h2 id="queue-title">Antrian (0)</h2>
                <ul id="queue-list"></ul>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Dibuat oleh <a href="https://github.com/jarvis-id" target="_blank">Jarvis-ID</a></p>
    </footer>
    
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // =======================================================================
        // ==  PENTING: SESUAIKAN DUA BARIS DI BAWAH INI DENGAN DATA ANDA  ==
        // =======================================================================

        // 1. Ganti 'MASUKKAN_CLIENT_ID_ANDA_DI_SINI' dengan Client ID dari Spotify.
        const clientId = '883a07283b8548c2ae527193c6c69db3'; 
        
        // 2. Ini adalah alamat situs GitHub Pages Anda.
        const redirectUri = 'https://jarvis-id.github.io/';
        
        // =======================================================================

        const scopes = [
            'streaming',
            'user-read-email',
            'user-read-private',
            'user-read-playback-state',
            'user-modify-playback-state'
        ];

        let accessToken = null;
        let player = null;
        let deviceId = null;
        const songQueue = []; 
        let isPlaying = false;
        let currentTrackUri = null;

        window.addEventListener('load', () => {
            accessToken = getAccessTokenFromUrl();
            if (accessToken) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('player-screen').style.display = 'block';
                initializePlayer();
            } else {
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('player-screen').style.display = 'none';
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            let url = 'https://accounts.spotify.com/authorize';
            url += '?response_type=token';
            url += '&client_id=' + encodeURIComponent(clientId);
            url += '&scope=' + encodeURIComponent(scopes.join(' '));
            url += '&redirect_uri=' + encodeURIComponent(redirectUri);
            window.location = url;
        });

        function getAccessTokenFromUrl() {
            const hash = window.location.hash.substring(1).split('&').reduce((initial, item) => {
                if (item) {
                    var parts = item.split('=');
                    initial[parts[0]] = decodeURIComponent(parts[1]);
                }
                return initial;
            }, {});
            window.location.hash = '';
            return hash.access_token;
        }

        function initializePlayer() {
            window.onSpotifyWebPlaybackSDKReady = () => {
                player = new Spotify.Player({
                    name: 'Web Player by Jarvis-ID',
                    getOAuthToken: cb => { cb(accessToken); },
                    volume: 0.5
                });

                player.addListener('initialization_error', ({ message }) => { console.error('Init Error:', message); });
                player.addListener('authentication_error', ({ message }) => { console.error('Auth Error:', message); alert('Sesi login berakhir, silakan refresh dan login kembali.'); });
                player.addListener('account_error', ({ message }) => { alert('Error: Akun Spotify Anda harus Premium untuk menggunakan fitur ini.'); });
                player.addListener('playback_error', ({ message }) => { console.error('Playback Error:', message); });

                player.addListener('player_state_changed', state => {
                    if (!state) return;
                    
                    updateCurrentTrackUI(state.track_window.current_track);
                    currentTrackUri = state.track_window.current_track.uri;

                    // Deteksi lagu selesai untuk memutar lagu berikutnya
                    if (isPlaying && state.paused && state.position === 0 && state.track_window.previous_tracks.find(t => t.uri === currentTrackUri)) {
                        console.log("Lagu selesai, memutar berikutnya...");
                        songQueue.shift();
                        updateQueueList();
                        playNextSong();
                    }
                    isPlaying = !state.paused;
                });

                player.addListener('ready', ({ device_id }) => {
                    console.log('Player siap dengan Device ID:', device_id);
                    deviceId = device_id;
                });
                
                player.connect().then(success => {
                    if (success) {
                        console.log('Spotify Player berhasil terhubung.');
                    }
                });
            };
        }

        async function searchTrack(query) {
            const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=5`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const data = await response.json();
            return data.tracks.items[0];
        }
        
        document.getElementById('add-btn').addEventListener('click', async () => {
            const query = document.getElementById('song-input').value;
            if (!query) return;

            const track = await searchTrack(query);
            if (track) {
                songQueue.push(track);
                document.getElementById('song-input').value = '';
                updateQueueList();
                
                if (!isPlaying && songQueue.length === 1) {
                    playNextSong();
                }
            } else {
                alert('Lagu tidak ditemukan!');
            }
        });
        
        document.getElementById('song-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('add-btn').click();
        });

        async function playSong(spotify_uri) {
            if (!deviceId) {
                alert("Player belum siap. Silakan tunggu beberapa saat.");
                return;
            }
            await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                method: 'PUT',
                body: JSON.stringify({ uris: [spotify_uri] }),
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
            });
        }
        
        function playNextSong() {
            if (songQueue.length > 0) {
                playSong(songQueue[0].uri);
            } else {
                isPlaying = false;
                console.log("Antrian kosong.");
                // Opsional: Anda bisa menghentikan player jika antrian kosong
                // player.pause();
            }
        }
        
        function updateQueueList() {
            const queueList = document.getElementById('queue-list');
            queueList.innerHTML = '';
            document.getElementById('queue-title').textContent = `Antrian (${songQueue.length})`;
            songQueue.forEach((track, index) => {
                if (index === 0) return; // Jangan tampilkan lagu yang sedang diputar di antrian
                const li = document.createElement('li');
                li.textContent = `${index}. ${track.name} - ${track.artists[0].name}`;
                queueList.appendChild(li);
            });
        }
        
        function updateCurrentTrackUI(track) {
            if (!track) {
                document.getElementById('track-name').textContent = "Tidak ada lagu yang diputar";
                document.getElementById('artist-name').textContent = "...";
                document.getElementById('album-art').src = "https://i.scdn.co/image/ab67616d0000b2733b5e11ca1b063583df9492db"; // Gambar placeholder
                return;
            };
            document.getElementById('track-name').textContent = track.name;
            document.getElementById('artist-name').textContent = track.artists.map(artist => artist.name).join(', ');
            document.getElementById('album-art').src = track.album.images[0].url;
            updateQueueList(); // Perbarui antrian untuk menghapus lagu yang kini diputar
        }

    </script>
</body>
</html>
