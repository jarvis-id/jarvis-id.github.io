<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Queue Player</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #ffffff; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; min-height: 100vh; box-sizing: border-box; }
        .container { width: 100%; max-width: 800px; background-color: #1e1e1e; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
        h1, h2 { text-align: center; color: #1DB954; }
        #login-screen, #player-screen { width: 100%; }
        #login-screen { text-align: center; padding: 50px 0; }
        .spotify-btn { background-color: #1DB954; color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; text-decoration: none; transition: background-color 0.2s; }
        .spotify-btn:hover { background-color: #1ED760; }
        #player-info { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; background-color: #282828; padding: 10px; border-radius: 8px; }
        #album-art { width: 80px; height: 80px; border-radius: 4px; object-fit: cover; }
        #track-info { display: flex; flex-direction: column; justify-content: center; }
        #track-name { font-size: 1.2em; font-weight: bold; }
        #artist-name { color: #b3b3b3; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        #song-input { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #555; background-color: #333; color: #fff; font-size: 16px; }
        #add-btn { padding: 10px 20px; border: none; border-radius: 5px; background-color: #1DB954; color: #ffffff; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #queue-list { list-style: none; padding: 0; }
        #queue-list li { background-color: #282828; padding: 10px 15px; border-radius: 5px; margin-bottom: 8px; }
        footer { margin-top: 30px; color: #555; text-align: center; font-size: 0.9em; }
        footer a { color: #888; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spotify Queue Player</h1>
        
        <div id="login-screen">
            <p>Login dengan akun Spotify Premium untuk memulai.</p>
            <button id="login-btn" class="spotify-btn">Login dengan Spotify</button>
        </div>

        <div id="player-screen" style="display:none;">
            <div id="player-info">
                <img id="album-art" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Album Art">
                <div id="track-info">
                    <div id="track-name">Tidak ada lagu yang diputar</div>
                    <div id="artist-name">...</div>
                </div>
            </div>

            <div class="controls">
                <input type="text" id="song-input" placeholder="Cari judul lagu dan artis...">
                <button id="add-btn">Tambah ke Antrian</button>
            </div>

            <div class="queue-container">
                <h2 id="queue-title">Antrian (0)</h2>
                <ul id="queue-list"></ul>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Dibuat oleh <a href="https://github.com/jarvis-id" target="_blank">Jarvis-ID</a></p>
    </footer>
    
    <script>
        // --- KONFIGURASI ---
        const clientId = '883a07283b8548c2ae527193c6c69db3';
        const redirectUri = 'https://jarvis-id.github.io/';
        // ---------------------

        const scopes = [
            'streaming',
            'user-read-email',
            'user-read-private',
            'user-read-playback-state',
            'user-modify-playback-state'
        ];

        let accessToken = null;
        let player = null;
        let deviceId = null;
        const songQueue = []; 
        let isPlaying = false;
        let currentTrackUri = null;

        window.onload = () => {
            const hash = getHashParams();
            if (hash.access_token) {
                accessToken = hash.access_token;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('player-screen').style.display = 'block';
                loadSpotifySDK();
            }
        };

        function getHashParams() {
            const hashParams = {};
            let e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            // Bersihkan hash dari URL agar tidak terlihat
            window.history.pushState("", document.title, window.location.pathname + window.location.search);
            return hashParams;
        }

        function loadSpotifySDK() {
            const script = document.createElement('script');
            script.src = "https://sdk.scdn.co/spotify-player.js";
            script.async = true;
            document.body.appendChild(script);

            window.onSpotifyWebPlaybackSDKReady = () => {
                initializePlayer();
            };
        }

        document.getElementById('login-btn').addEventListener('click', () => {
            let url = 'https://accounts.spotify.com/authorize';
            url += '?response_type=token';
            url += '&client_id=' + encodeURIComponent(clientId);
            url += '&scope=' + encodeURIComponent(scopes.join(' '));
            url += '&redirect_uri=' + encodeURIComponent(redirectUri);
            window.location = url;
        });

        function initializePlayer() {
            player = new Spotify.Player({
                name: 'Web Player by Jarvis-ID',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 0.5
            });

            player.addListener('ready', ({ device_id }) => {
                console.log('Player siap dengan Device ID:', device_id);
                deviceId = device_id;
            });

            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID', device_id, 'telah offline');
            });

            player.addListener('initialization_error', ({ message }) => { console.error('Gagal inisialisasi:', message); });
            player.addListener('authentication_error', ({ message }) => { console.error('Gagal otentikasi:', message); alert('Sesi login berakhir, silakan refresh dan login kembali.'); });
            player.addListener('account_error', ({ message }) => { alert('Error: Akun Spotify Anda harus Premium untuk menggunakan fitur ini.'); });

            player.addListener('player_state_changed', state => {
                if (!state) { return; }
                
                const currentTrack = state.track_window.current_track;
                const newTrackUri = currentTrack.uri;
                updateCurrentTrackUI(currentTrack);

                if (isPlaying && state.paused && currentTrackUri !== newTrackUri) {
                    songQueue.shift();
                    playNextSong();
                }

                currentTrackUri = newTrackUri;
                isPlaying = !state.paused;
            });

            player.connect().then(success => {
                if (success) {
                    console.log('Spotify Player berhasil terhubung.');
                }
            });
        }
        
        document.getElementById('add-btn').addEventListener('click', handleAddSong);
        document.getElementById('song-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAddSong();
        });

        async function handleAddSong() {
            const query = document.getElementById('song-input').value.trim();
            if (!query) return;

            const track = await searchTrack(query);
            if (track) {
                songQueue.push(track);
                document.getElementById('song-input').value = '';
                updateQueueList();
                
                if (!isPlaying && songQueue.length === 1) {
                    playNextSong();
                }
            } else {
                alert('Lagu tidak ditemukan!');
            }
        }

        async function searchTrack(query) {
            const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) {
                console.error("Gagal mencari lagu, token mungkin sudah kedaluwarsa.");
                return null;
            }
            const data = await response.json();
            return data.tracks.items[0];
        }

        async function playSong(spotify_uri) {
            if (!deviceId) {
                alert("Player belum siap. Silakan tunggu beberapa saat atau coba putar lagu dari aplikasi Spotify lain untuk mengaktifkan player ini.");
                return;
            }
            try {
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ uris: [spotify_uri] }),
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                });
            } catch (error) {
                console.error("Gagal memutar lagu:", error);
            }
        }
        
        function playNextSong() {
            if (songQueue.length > 0) {
                playSong(songQueue[0].uri);
            } else {
                isPlaying = false;
                console.log("Antrian kosong.");
                // player.pause(); // Uncomment jika ingin player berhenti saat antrian kosong
            }
        }
        
        function updateQueueList() {
            const queueList = document.getElementById('queue-list');
            queueList.innerHTML = '';
            const waitingSongs = songQueue.slice(1); // Ambil semua lagu kecuali yang pertama (sedang diputar)
            document.getElementById('queue-title').textContent = `Antrian (${waitingSongs.length})`;

            waitingSongs.forEach((track, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${track.name} - ${track.artists.map(a => a.name).join(', ')}`;
                queueList.appendChild(li);
            });
        }
        
        function updateCurrentTrackUI(track) {
            if (!track) {
                document.getElementById('track-name').textContent = "Tidak ada lagu yang diputar";
                document.getElementById('artist-name').textContent = "...";
                document.getElementById('album-art').src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
            } else {
                document.getElementById('track-name').textContent = track.name;
                document.getElementById('artist-name').textContent = track.artists.map(artist => artist.name).join(', ');
                document.getElementById('album-art').src = track.album.images[0].url;
            }
            updateQueueList();
        }
    </script>
</body>
</html>
